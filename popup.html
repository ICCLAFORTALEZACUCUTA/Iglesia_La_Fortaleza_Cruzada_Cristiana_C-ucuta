<script>
    // --- FUNCIONES GLOBALES (ACCESIBLES INMEDIATAMENTE) ---

    // Datos de las sedes. AJUSTA ESTA LISTA y los data-id en el HTML para que coincidan.
    // Declaramos 'sedes' aquí para que sea accesible por initializeSedeSelector
    const sedes = [
        { id: 'aeropuerto', name: 'Centro Cristiano Aeropuerto' },
        { id: 'atalaya', name: 'Centro Cristiano Atalaya' },
        { id: 'belen', name: 'Centro Cristiano Belén' },
        { id: 'colinas', name: 'Centro Cristiano Colinas' },
        { id: 'donanidia', name: 'Centro Cristiano Doña Nidia' },
        { id: 'libertad', name: 'Centro Cristiano Libertad' },
        { id: 'lospinos', name: 'Centro Cristiano Los Pinos' },
        { id: 'prados', name: 'Centro Cristiano Prados del Este' },
        { id: 'sanmartin', name: 'Centro Cristiano San Martín' },
        { id: 'tucunare', name: 'Centro Cristiano Tucunaré' },
        { id: 'vallesther', name: 'Centro Cristiano Vallesther' }
    ].sort((a, b) => a.name.localeCompare(b.name)); // Ordenar alfabéticamente

    // Función global para rellenar el selector de sedes
    // Ahora es una función independiente y global
    window.initializeSedeSelector = function() {
        console.log("popup.html: Inicializando selector de sedes.");
        const sedeSelector = document.getElementById('sede-selector');
        if (sedeSelector) {
            sedeSelector.innerHTML = ''; // Limpiar opciones existentes

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecciona una Sede...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            sedeSelector.appendChild(defaultOption);

            sedes.forEach(sede => {
                const option = document.createElement('option');
                option.value = sede.id;
                option.textContent = sede.name;
                sedeSelector.appendChild(option);
            });
            console.log("popup.html: Selector de sedes rellenado.");
        } else {
            console.error("popup.html ERROR: #sede-selector no encontrado para inicializar.");
        }
    };

    // Función global para mostrar la sede seleccionada
    // También la hacemos global para que esté disponible cuando se llame a initializeSedeSelector
    window.showSelectedSede = function() {
        const sedeSelector = document.getElementById('sede-selector');
        const churchesContainer = document.getElementById('churches-container');

        if (!sedeSelector || !churchesContainer) {
            console.error("popup.html ERROR: Elementos de selector o contenedor no encontrados para showSelectedSede.");
            return;
        }

        const selectedId = sedeSelector.value;
        console.log(`popup.html: Sede seleccionada en el dropdown: ${selectedId}`);
        
        const churchDetailsElements = churchesContainer.querySelectorAll('.church-details');
        churchDetailsElements.forEach(churchElement => {
            if (churchElement.getAttribute('data-id') === selectedId) {
                churchElement.classList.add('active'); // Muestra la sede seleccionada
                console.log(`popup.html: Mostrando detalles de la sede: ${selectedId}`);
            } else {
                churchElement.classList.remove('active'); // Oculta las demás
            }
        });
    };

    // Función global para abrir el modal (llamada desde index.html)
    window.openChurchModal = function() {
        console.log("popup.html: Función 'openChurchModal' llamada desde el exterior.");
        const churchModal = document.getElementById('churchModal');
        if (churchModal) {
            churchModal.style.display = 'flex'; // Hace visible el modal
            console.log(`popup.html: 'churchModal' display establecido a: ${churchModal.style.display}`);
            
            // Re-inicializar el selector y ocultar todas las sedes al abrir para un estado limpio
            // Las funciones initializeSedeSelector y showSelectedSede son ahora globales (window.)
            window.initializeSedeSelector(); 
            const churchesContainer = document.getElementById('churches-container');
            if (churchesContainer) {
                churchesContainer.querySelectorAll('.church-details').forEach(el => el.classList.remove('active')); // Oculta todos los detalles de sede
                // Opcional: seleccionar la primera sede por defecto si no hay ninguna seleccionada
                const sedeSelector = document.getElementById('sede-selector');
                if (sedeSelector && sedeSelector.options.length > 1) {
                    sedeSelector.value = ''; // Resetea a la opción "Selecciona una Sede..."
                    // Si quisieras que la primera sede de la lista se muestre automáticamente:
                    // sedeSelector.value = sedes[0].id; // Asume que 'sedes' está disponible
                    // window.showSelectedSede();
                }
                console.log("popup.html: Selector y sedes reseteados al abrir.");
            } else {
                 console.warn("popup.html ADVERTENCIA: Contenedor de iglesias no encontrado al abrir el modal.");
            }
        } else {
            console.error("popup.html ERROR: #churchModal no se encontró al intentar abrir el modal.");
        }
    };

    // --- LÓGICA DE EVENTOS (se ejecuta después de que el DOM del popup esté completamente cargado) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("popup.html: DOMContentLoaded - Script del popup cargado.");

        const churchModal = document.getElementById('churchModal');
        const closeModalButton = churchModal ? churchModal.querySelector('.close-button') : null;
        const sedeSelector = document.getElementById('sede-selector');
        //const churchesContainer = document.getElementById('churches-container'); // Ya lo tenemos en global context

        // Validaciones iniciales para elementos del popup (útil para depuración)
        if (!churchModal) {
            console.error("popup.html ERROR: No se encontró '#churchModal'. El modal podría no funcionar.");
            return; 
        }
        if (!closeModalButton) {
            console.warn("popup.html ADVERTENCIA: No se encontró el botón de cierre '.close-button'.");
        }
        if (!sedeSelector) {
            console.error("popup.html ERROR: No se encontró el selector de sede '#sede-selector'.");
        }
        // if (!churchesContainer) { ... ya se chequea arriba ... }
        console.log("popup.html: Elementos principales del modal encontrados para listeners.");

        // --- Event Listeners del modal ---
        if (closeModalButton) {
            closeModalButton.addEventListener('click', function() {
                churchModal.style.display = 'none';
                console.log("popup.html: Modal cerrado por clic en botón 'x'.");
            });
        }

        if (churchModal) { 
            churchModal.addEventListener('click', function(event) {
                if (event.target === churchModal) { // Solo si el clic es en el overlay y no en el contenido
                    churchModal.style.display = 'none';
                    console.log("popup.html: Modal cerrado por clic en el overlay.");
                }
            });
        }

        if (sedeSelector) {
            // El event listener para 'change' llama a la función global showSelectedSede
            sedeSelector.addEventListener('change', window.showSelectedSede);
        }
    });
</script>
